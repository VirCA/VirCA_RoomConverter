<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>VirCA Room Converter</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>
<body>   
    <div id="plane">
        <div id="uploads"></div>
        <p><font size="8" color="white"> VirCA Room Converter</font></p>
        <p>Drag and Drop your files, click to the "Submit" button. When the "Download" button turn enabled, click to that, and your room file will start to download automatically. No matter the sequence, you can choose first scene and scfg files too. You can start a new convertation if you click to the "Remove selected file(s)" button.
        </p>
        <div class="dropzone" id="dropzone">
            <label id="dNdtext">Drop scene and scfg files here.</label>
            <div id="left" class="upl">
                
            </div>
            <div id="right" class="upl"></div>
            
        </div>
            <label>If you used Easy Ogre Exporter:</label>
            <input id="scales" type="checkbox" name="easyOgreExport">
            <div id="dNd-buttons">
                <button class="btn btn-primary btn-lg btn-disabled" id="submit">Upload files</button>
                <button class="btn btn-primary btn-lg" id="myButton">Remove selected file(s)</button>
            </div>
</div>

    <script type="text/javascript">
        var left = document.getElementById('left');
        var right = document.getElementById('right');
        var dropzone = document.getElementById('dropzone');
        var button = document.getElementById('myButton');
        var smt = document.getElementById("submit");
        var rmv = document.getElementById("myButton");
        var files = undefined;
        var xhr = new XMLHttpRequest();
        var roomName = "";
        var data = "";
        var easyOgreExport;
        

        (function () {         
            var upload = function (files) {
                
                
                smt.onclick = function () {

                    var formData = new FormData();
                    for (var i = 0; i < files.length; i++) {
                        formData.append('file', files[i]);
                        //console.log(files[i]);
                    }
                    easyOgreExport = document.getElementById('scales');
                    if(easyOgreExport.checked)
                        formData.append('easyOgreExport', "on");
                    if (files != undefined) {
                        //console.log(files);
                        xhr.open('post', '/upload');
                        //console.log(formData);
                        xhr.send(formData);
                        xhr.onloadend = function () {
                            data = xhr.responseText;
                            console.log("Convertation done.");
                            window.open("/settings.html");
                        }
                        formData = undefined;
                       // console.log(xhr);
                    }
                };
                rmv.onclick = function () {
                    files = undefined;
                    left.className = '';
                    left.textContent = '';
                    right.className = '';
                    right.textContent = '';
                    document.getElementById('dNdtext').textContent = "Drop scene and scfg files here.";
                    //console.log(files);
                    dropzone.className = 'dropzone';
                    easyOgreExport = undefined;
                };
            }

           
           
            dropzone.ondrop = function (e) {
                e.preventDefault();
                files = e.dataTransfer.files;

                roomName = getRoomName(files);
                console.log("Your room name: " + roomName);

                if (files[0] != undefined && files[1] != undefined) {
                    
                    left.className = 'uplNEW';
                    left.textContent = files[0].name;
                    right.className = 'uplNEW';
                    right.textContent = files[1].name;
                    document.getElementById('dNdtext').textContent = "";
                   // console.log(files);
                    upload(files);
                }
                else if (files[0] != undefined && files[1] == undefined) {
                    left.className = 'uplNEW';
                    left.textContent = files[0].name;
                    right.className = '';
                    right.textContent = '';
                    document.getElementById('dNdtext').textContent = "";
                    //console.log(files);
                    upload(files);
                }
            }
            dropzone.ondragover = function () {
                this.className = 'dropzone dragover';
                return false;
            }
            dropzone.ondragleave = function () {
                this.className = 'dropzone';
                return false;
            }
        }());

        function getRoomName(files) {
            
            if (files[0].name.indexOf(".scene") >= 0) {
                return files[0].name.substring(0, files[0].name.indexOf(".scene"));
            }
            else if (files.length > 1 && files[1].name.indexOf(".scene") >= 0) {
                return files[0].name.substring(0, files[0].name.indexOf(".scene"));
            }
            return;
        }
        function populateIframe(id, path) {
            var ifrm = document.getElementById(id);
            ifrm.src = path;
        }
       

    </script>
</body>
</html>